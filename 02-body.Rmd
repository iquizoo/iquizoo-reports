# 报告正文

```{r setup-body-content}
body_child_file <- file.path(
  getOption("reports.archytype"),
  with(
    params,
    switch(
      report_unit,
      default = str_glue("body.{customer_id}.Rmd"),
      str_glue("body.{customer_id}.{report_unit}.Rmd")
    )
  )
)
score_levels <- config::get("score.level")
```

```{r get-blai-content, results='asis'}
ab_code <- "blai"
ab_name <- "大脑学习能力"
ab_hlevel <- 2
ab_hstyle <- "标题2-编号"
ab_def <- "大脑学习能力反映了注意力、记忆力、自控力、反应力和思维力这五个方面的综合水平，分数越高代表大脑学习能力的综合发展水平越高。"
text_to_render_blai <- knitr::knit_expand(
  text = readLines(body_child_file, encoding = "UTF-8")
)
cat(knitr::knit(text = text_to_render_blai, quiet = TRUE))
```

::: {custom-style="标题2-编号-换页"}
## 各能力单独报告
:::

```{r get-body-content, results='asis'}
report_abilities <- config::get("report.ability") %>%
  as_tibble()
n_abilities <- nrow(report_abilities)
text_to_render <- character(length = n_abilities)
for (i_row in 1:n_abilities) {
  ab_code <- report_abilities[[i_row, "code"]]
  ab_name <- report_abilities[[i_row, "name"]]
  ab_hlevel <- report_abilities[[i_row, "hlevel"]]
  ab_hstyle <- report_abilities[[i_row, "hstyle"]]
  ab_def <- report_abilities[[i_row, "def"]]
  text_to_render[i_row] <- knitr::knit_expand(
    text = readLines(body_child_file, encoding = "UTF-8")
  )
}
cat(knitr::knit(text = text_to_render, quiet = TRUE))
```

::: {custom-style="标题2-编号-换页"}
## 综合报告
:::

下面对拥有五大能力测评的完整数据的学生（计`r sum(complete.cases(dataset))`名）分为六大类别，并在表\@ref(tab:student-classification)中给出各班每种类别学生数目。六大类别如下：

* **杰出型**: 基础学习能力发展非常突出，整体发展水平显著高于全国常模平均数。
* **优秀型**：基础学习能力发展优秀，整体发展水平均高于全国常模平均数。
* **平衡型**：基础学习能力发展均衡，整体发展水基本处于同龄人平均水平。
* **有待改进型**：基础学习能力相对不足，略低于同龄人水平。
* **亟待提升型**：基础学习能力发展上相对迟缓，整体发展水平目前还落后于同龄人水平，各项学习能力提高空间较大。
* **不均衡型**：基础学习能力发展不均衡，部分能力的发展上超过了同龄人水平，另一部分能力的发展上存在滞后。

```{r student-classification}
dataset_complete <- dataset[complete.cases(dataset), ]
dataset_complete %>% 
  pivot_longer(one_of(report_abilities$code), names_to = "ability", values_to = "score") %>% 
  mutate(level = fct_rev(cut(score, qnorm(c(0, 0.3, 0.7, 0.9, 1)) * 15 + 100, LETTERS[4:1]))) %>% 
  group_by(!!!syms(user_prop_used), level) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = "level", values_from = "n", values_fill = list(n = 0)) %>% 
  mutate(
    type = case_when(
      A >= 3 & C == 0 & D == 0 ~ "杰出型",
      A + B >= 4 & C <= 1 & D == 0 ~ "优秀型",
      A + B == 3 & D == 0 ~ "平衡型",
      A <= 2 & D <= 1 ~ "有待改进型",
      D >= 2 ~ "亟待提升型",
      TRUE ~ "不均衡型"
    ) %>% 
      factor(c("杰出型", "优秀型", "平衡型", "有待改进型", "亟待提升型", "不均衡型"))
  ) %>% 
  group_by(class, type) %>% 
  summarise(n = n()) %>% 
  spread(type, n, fill = 0) %>% 
  rename(导师 = class) %>% 
  knitr::kable(caption = "各班级中各类型学生人数")
```
